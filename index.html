<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Rat Factor üéæ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent-yellow: #f0e130;
            --accent-green: #00ff88;
            --accent-pink: #ff6b9d;
            --text-light: #eaeaea;
            --text-muted: #8892a0;
            --border-subtle: rgba(255,255,255,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 1000;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0 20px;
            position: relative;
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem;
            letter-spacing: 4px;
            color: var(--accent-yellow);
            text-shadow: 3px 3px 0 var(--accent-pink);
            animation: titlePulse 3s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .header .subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .header .rat {
            font-size: 2rem;
            margin: 10px 0 0;
            display: inline-block;
            animation: ratScurry 2s ease-in-out;
            animation-fill-mode: forwards;
        }

        @keyframes ratScurry {
            0% {
                transform: translateX(-100vw) scaleX(-1) rotate(0deg);
            }
            5% {
                transform: translateX(-90vw) scaleX(-1) rotate(-5deg);
            }
            10% {
                transform: translateX(-80vw) scaleX(-1) rotate(5deg);
            }
            15% {
                transform: translateX(-70vw) scaleX(-1) rotate(-5deg);
            }
            20% {
                transform: translateX(-60vw) scaleX(-1) rotate(5deg);
            }
            25% {
                transform: translateX(-50vw) scaleX(-1) rotate(-5deg);
            }
            30% {
                transform: translateX(-40vw) scaleX(-1) rotate(5deg);
            }
            35% {
                transform: translateX(-30vw) scaleX(-1) rotate(-5deg);
            }
            40% {
                transform: translateX(-20vw) scaleX(-1) rotate(5deg);
            }
            45% {
                transform: translateX(20px) scaleX(-1) rotate(0deg);
            }
            50% {
                transform: translateX(20px) scaleX(-1) rotate(0deg);
            }
            55% {
                transform: translateX(20px) scaleX(1) rotate(180deg);
            }
            60% {
                transform: translateX(15px) scaleX(1) rotate(175deg);
            }
            65% {
                transform: translateX(10px) scaleX(1) rotate(185deg);
            }
            70% {
                transform: translateX(-5px) scaleX(1) rotate(175deg);
            }
            75% {
                transform: translateX(0px) scaleX(1) rotate(185deg);
            }
            80% {
                transform: translateX(3px) scaleX(1) rotate(178deg);
            }
            90% {
                transform: translateX(-1px) scaleX(1) rotate(182deg);
            }
            100% {
                transform: translateX(0) scaleX(1) rotate(180deg);
            }
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-tab {
            flex: 1;
            min-width: fit-content;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .nav-tab:hover {
            border-color: var(--accent-yellow);
        }

        .nav-tab.active {
            background: var(--accent-yellow);
            color: var(--bg-dark);
            border-color: var(--accent-yellow);
            font-weight: 700;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 2px;
            color: var(--accent-green);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Leaderboard - WSL style */
        .leaderboard-table {
            width: 100%;
        }

        .leaderboard-header {
            display: flex;
            padding: 8px 12px;
            border-bottom: 2px solid var(--accent-yellow);
            margin-bottom: 2px;
            font-size: 0.65rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .leaderboard-header-rank { width: 45px; text-align: center; }
        .leaderboard-header-name { flex: 1; }
        .leaderboard-header-pts { width: 60px; text-align: center; }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.2s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            width: 45px;
            text-align: center;
            color: var(--text-muted);
        }

        .leaderboard-item.rank-1 .leaderboard-rank { color: #ffd700; }
        .leaderboard-item.rank-2 .leaderboard-rank { color: #c0c0c0; }
        .leaderboard-item.rank-3 .leaderboard-rank { color: #cd7f32; }

        .leaderboard-name {
            flex: 1;
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .leaderboard-score {
            width: 60px;
            text-align: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-yellow);
        }

        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-dark);
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            appearance: none;
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238892a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 45px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--accent-yellow);
        }

        .form-select option {
            background: var(--bg-dark);
        }

        /* Player selection grid */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .player-toggle {
            padding: 15px;
            background: var(--bg-dark);
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .player-toggle:hover {
            border-color: var(--accent-green);
        }

        .player-toggle.selected {
            background: var(--accent-green);
            color: var(--bg-dark);
            border-color: var(--accent-green);
            font-weight: 700;
        }

        .player-toggle.winner {
            background: var(--accent-yellow);
            color: var(--bg-dark);
            border-color: var(--accent-yellow);
        }

        /* Score inputs */
        .score-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .score-input-group {
            text-align: center;
        }

        .score-input-group label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .score-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--accent-yellow);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            text-align: center;
        }

        .score-input:focus {
            outline: none;
            border-color: var(--accent-yellow);
        }

        /* Submit button */
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: var(--accent-yellow);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(240, 225, 48, 0.3);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Match history */
        .match-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .match-item:last-child {
            border-bottom: none;
        }

        .match-type {
            font-size: 0.65rem;
            color: var(--accent-pink);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .match-players {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .match-winner {
            color: var(--accent-green);
            font-weight: 700;
        }

        .match-date {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Head to head */
        .h2h-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .h2h-selector select {
            flex: 1;
        }

        .h2h-vs {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-pink);
        }

        .h2h-result {
            text-align: center;
            padding: 30px;
        }

        .h2h-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem;
            color: var(--accent-yellow);
        }

        .h2h-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        /* Insights */
        .insight-item {
            padding: 15px;
            background: rgba(0, 255, 136, 0.05);
            border-left: 3px solid var(--accent-green);
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .insight-item.streak {
            border-left-color: var(--accent-pink);
            background: rgba(255, 107, 157, 0.05);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent-green);
            color: var(--bg-dark);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 700;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--accent-pink);
        }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Team display for doubles */
        .team-section {
            margin-bottom: 15px;
        }

        .team-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        /* Canadian doubles specific */
        .canadian-players {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .canadian-player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .canadian-player-name {
            flex: 1;
            font-weight: 700;
        }

        .canadian-player-score {
            width: 60px;
        }

        .canadian-player-score input {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 2px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--accent-yellow);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            text-align: center;
        }

        .canadian-player-score input:focus {
            outline: none;
            border-color: var(--accent-yellow);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>RAT FACTOR</h1>
            <p class="subtitle">Tennis Tracker for the Chummery</p>
            <div class="rat">üêÄ</div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-section="home">Home</button>
            <button class="nav-tab" data-section="log">Log Match</button>
            <button class="nav-tab" data-section="history">History</button>
            <button class="nav-tab" data-section="h2h">H2H</button>
        </nav>

        <!-- HOME SECTION -->
        <section id="home" class="section active">
            <div class="card">
                <h2 class="card-title">üèÜ Rat Factor</h2>
                <div id="leaderboard" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üí° Insights</h2>
                <div id="insights">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </section>

        <!-- LOG MATCH SECTION -->
        <section id="log" class="section">
            <div class="card">
                <h2 class="card-title">üìù Log New Match</h2>
                
                <div class="form-group">
                    <label class="form-label">Match Type</label>
                    <select id="matchType" class="form-select">
                        <option value="">Select type...</option>
                        <option value="singles">Singles (1v1)</option>
                        <option value="doubles">Doubles (2v2)</option>
                        <option value="canadian">Canadian Doubles (3 players)</option>
                    </select>
                </div>

                <div id="matchForm" style="display: none;"></div>
            </div>
        </section>

        <!-- HISTORY SECTION -->
        <section id="history" class="section">
            <div class="card">
                <h2 class="card-title">üìú Match History</h2>
                <div id="matchHistory">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </section>

        <!-- HEAD TO HEAD SECTION -->
        <section id="h2h" class="section">
            <div class="card">
                <h2 class="card-title">‚öîÔ∏è Head to Head</h2>
                
                <div class="h2h-selector">
                    <select id="h2hPlayer1" class="form-select">
                        <option value="">Player 1</option>
                        <option value="Rick">Rick</option>
                        <option value="Ed">Ed</option>
                        <option value="Tom">Tom</option>
                        <option value="Jethro">Jethro</option>
                    </select>
                    <span class="h2h-vs">VS</span>
                    <select id="h2hPlayer2" class="form-select">
                        <option value="">Player 2</option>
                        <option value="Rick">Rick</option>
                        <option value="Ed">Ed</option>
                        <option value="Tom">Tom</option>
                        <option value="Jethro">Jethro</option>
                    </select>
                </div>

                <div id="h2hResult"></div>
            </div>
        </section>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Supabase setup
        const SUPABASE_URL = 'https://osbbviimzoqaeyneogtp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_7LNEQqzEeiCw_giwIWP44g_8M7_cxvz';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const PLAYERS = ['Rick', 'Ed', 'Tom', 'Jethro'];

        // State
        let matches = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            initMatchTypeSelector();
            initH2HSelectors();
            loadMatches();
        });

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.section).classList.add('active');
                });
            });
        }

        // Match type selector
        function initMatchTypeSelector() {
            document.getElementById('matchType').addEventListener('change', (e) => {
                renderMatchForm(e.target.value);
            });
        }

        // Render match form based on type
        function renderMatchForm(type) {
            const container = document.getElementById('matchForm');
            
            if (!type) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            if (type === 'singles') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Player 1</label>
                        <select id="singlesP1" class="form-select">
                            <option value="">Select player...</option>
                            ${PLAYERS.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Player 2</label>
                        <select id="singlesP2" class="form-select">
                            <option value="">Select player...</option>
                            ${PLAYERS.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Winner</label>
                        <select id="singlesWinner" class="form-select">
                            <option value="">Select winner...</option>
                        </select>
                    </div>
                    <button class="btn-submit" onclick="submitSingles()">LOG MATCH</button>
                `;

                // Update winner dropdown when players change
                ['singlesP1', 'singlesP2'].forEach(id => {
                    document.getElementById(id).addEventListener('change', updateSinglesWinnerOptions);
                });
            } else if (type === 'doubles') {
                container.innerHTML = `
                    <div class="team-section">
                        <div class="team-label">TEAM 1</div>
                        <div class="player-grid">
                            ${PLAYERS.map(p => `<button class="player-toggle" data-team="1" data-player="${p}">${p}</button>`).join('')}
                        </div>
                    </div>
                    <div class="team-section">
                        <div class="team-label">TEAM 2</div>
                        <div class="player-grid">
                            ${PLAYERS.map(p => `<button class="player-toggle" data-team="2" data-player="${p}">${p}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Winning Team</label>
                        <select id="doublesWinner" class="form-select">
                            <option value="">Select winning team...</option>
                            <option value="1">Team 1</option>
                            <option value="2">Team 2</option>
                        </select>
                    </div>
                    <button class="btn-submit" onclick="submitDoubles()">LOG MATCH</button>
                `;

                // Team selection logic
                document.querySelectorAll('.player-toggle').forEach(btn => {
                    btn.addEventListener('click', handleDoublesPlayerToggle);
                });
            } else if (type === 'canadian') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Select 3 Players</label>
                        <div class="player-grid">
                            ${PLAYERS.map(p => `<button class="player-toggle canadian-toggle" data-player="${p}">${p}</button>`).join('')}
                        </div>
                    </div>
                    <div id="canadianScores" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Final Scores</label>
                            <div class="canadian-players" id="canadianPlayerScores"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Score</label>
                            <select id="canadianTarget" class="form-select">
                                <option value="11">First to 11</option>
                                <option value="7">First to 7</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-submit" onclick="submitCanadian()">LOG MATCH</button>
                `;

                document.querySelectorAll('.canadian-toggle').forEach(btn => {
                    btn.addEventListener('click', handleCanadianPlayerToggle);
                });
            }
        }

        function updateSinglesWinnerOptions() {
            const p1 = document.getElementById('singlesP1').value;
            const p2 = document.getElementById('singlesP2').value;
            const winnerSelect = document.getElementById('singlesWinner');
            
            winnerSelect.innerHTML = '<option value="">Select winner...</option>';
            if (p1) winnerSelect.innerHTML += `<option value="${p1}">${p1}</option>`;
            if (p2 && p2 !== p1) winnerSelect.innerHTML += `<option value="${p2}">${p2}</option>`;
        }

        function handleDoublesPlayerToggle(e) {
            const btn = e.target;
            const team = btn.dataset.team;
            const player = btn.dataset.player;
            
            // Check if player is already on the other team
            const otherTeam = team === '1' ? '2' : '1';
            const otherTeamBtn = document.querySelector(`.player-toggle[data-team="${otherTeam}"][data-player="${player}"].selected`);
            if (otherTeamBtn) {
                otherTeamBtn.classList.remove('selected');
            }

            btn.classList.toggle('selected');

            // Limit to 2 per team
            const teamSelected = document.querySelectorAll(`.player-toggle[data-team="${team}"].selected`);
            if (teamSelected.length > 2) {
                teamSelected[0].classList.remove('selected');
            }
        }

        function handleCanadianPlayerToggle(e) {
            const btn = e.target;
            btn.classList.toggle('selected');

            const selected = document.querySelectorAll('.canadian-toggle.selected');
            if (selected.length > 3) {
                selected[0].classList.remove('selected');
            }

            updateCanadianScoresUI();
        }

        function updateCanadianScoresUI() {
            const selected = Array.from(document.querySelectorAll('.canadian-toggle.selected')).map(b => b.dataset.player);
            const scoresContainer = document.getElementById('canadianScores');
            const scoresDiv = document.getElementById('canadianPlayerScores');

            if (selected.length === 3) {
                scoresContainer.style.display = 'block';
                scoresDiv.innerHTML = selected.map(player => `
                    <div class="canadian-player-row">
                        <span class="canadian-player-name">${player}</span>
                        <div class="canadian-player-score">
                            <input type="number" id="score_${player}" min="0" placeholder="0">
                        </div>
                    </div>
                `).join('');
            } else {
                scoresContainer.style.display = 'none';
            }
        }

        // Submit functions
        async function submitSingles() {
            const p1 = document.getElementById('singlesP1').value;
            const p2 = document.getElementById('singlesP2').value;
            const winner = document.getElementById('singlesWinner').value;

            if (!p1 || !p2 || !winner || p1 === p2) {
                showToast('Please fill all fields correctly', true);
                return;
            }

            const match = {
                match_type: 'singles',
                player1: p1,
                player2: p2,
                winner1: winner
            };

            await saveMatch(match);
        }

        async function submitDoubles() {
            const team1 = Array.from(document.querySelectorAll('.player-toggle[data-team="1"].selected')).map(b => b.dataset.player);
            const team2 = Array.from(document.querySelectorAll('.player-toggle[data-team="2"].selected')).map(b => b.dataset.player);
            const winningTeam = document.getElementById('doublesWinner').value;

            if (team1.length !== 2 || team2.length !== 2 || !winningTeam) {
                showToast('Please select 2 players per team and a winner', true);
                return;
            }

            const winners = winningTeam === '1' ? team1 : team2;

            const match = {
                match_type: 'doubles',
                player1: team1[0],
                player2: team1[1],
                player3: team2[0],
                player4: team2[1],
                winner1: winners[0],
                winner2: winners[1]
            };

            await saveMatch(match);
        }

        async function submitCanadian() {
            const selected = Array.from(document.querySelectorAll('.canadian-toggle.selected')).map(b => b.dataset.player);
            
            if (selected.length !== 3) {
                showToast('Please select exactly 3 players', true);
                return;
            }

            const scores = {};
            let hasScores = true;
            selected.forEach(player => {
                const scoreInput = document.getElementById(`score_${player}`);
                const score = parseInt(scoreInput.value);
                if (isNaN(score)) hasScores = false;
                scores[player] = score;
            });

            if (!hasScores) {
                showToast('Please enter all scores', true);
                return;
            }

            const target = parseInt(document.getElementById('canadianTarget').value);

            const match = {
                match_type: 'canadian',
                player1: selected[0],
                player2: selected[1],
                player3: selected[2],
                score_player1: scores[selected[0]],
                score_player2: scores[selected[1]],
                score_player3: scores[selected[2]],
                target_score: target
            };

            await saveMatch(match);
        }

        async function saveMatch(match) {
            try {
                const { error } = await db.from('matches').insert([match]);
                
                if (error) throw error;

                showToast('Match logged! üéæ');
                document.getElementById('matchType').value = '';
                document.getElementById('matchForm').style.display = 'none';
                loadMatches();
                
                // Switch to home tab
                document.querySelector('.nav-tab[data-section="home"]').click();
            } catch (err) {
                console.error('Error saving match:', err);
                showToast('Error saving match', true);
            }
        }

        // Load matches
        async function loadMatches() {
            try {
                const { data, error } = await db
                    .from('matches')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                matches = data || [];
                renderLeaderboard();
                renderHistory();
                renderInsights();
            } catch (err) {
                console.error('Error loading matches:', err);
                document.getElementById('leaderboard').innerHTML = '<div class="empty-state">Error loading data</div>';
            }
        }

        // Render leaderboard
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard');
            const canadianMatches = matches.filter(m => m.match_type === 'canadian');

            if (canadianMatches.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéæ</div>No Canadian doubles matches yet</div>';
                return;
            }

            // Calculate points: 1st = 3pts, 2nd = 1pt, 3rd = 0pts
            const points = {};
            PLAYERS.forEach(p => points[p] = 0);

            canadianMatches.forEach(match => {
                const players = [
                    { name: match.player1, score: match.score_player1 || 0 },
                    { name: match.player2, score: match.score_player2 || 0 },
                    { name: match.player3, score: match.score_player3 || 0 }
                ].filter(p => p.name);

                players.sort((a, b) => b.score - a.score);

                if (players[0]) points[players[0].name] += 3;
                if (players[1]) points[players[1].name] += 1;
            });

            const sorted = Object.entries(points)
                .filter(([_, pts]) => pts > 0)
                .sort((a, b) => b[1] - a[1]);

            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéæ</div>No matches recorded yet</div>';
                return;
            }

            container.innerHTML = `
                <div class="leaderboard-table">
                    <div class="leaderboard-header">
                        <div class="leaderboard-header-rank">Rank</div>
                        <div class="leaderboard-header-name">Name</div>
                        <div class="leaderboard-header-pts">Points</div>
                    </div>
                    ${sorted.map(([name, pts], i) => `
                        <div class="leaderboard-item rank-${i + 1}">
                            <div class="leaderboard-rank">${i + 1}</div>
                            <div class="leaderboard-name">${name}</div>
                            <div class="leaderboard-score">${pts}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render history
        function renderHistory() {
            const container = document.getElementById('matchHistory');

            if (matches.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div>No matches logged yet</div>';
                return;
            }

            container.innerHTML = matches.slice(0, 20).map(match => {
                const date = new Date(match.created_at).toLocaleDateString('en-AU', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (match.match_type === 'singles') {
                    return `
                        <div class="match-item">
                            <div class="match-type">Singles</div>
                            <div class="match-players">
                                <span class="${match.winner1 === match.player1 ? 'match-winner' : ''}">${match.player1}</span>
                                vs
                                <span class="${match.winner1 === match.player2 ? 'match-winner' : ''}">${match.player2}</span>
                            </div>
                            <div class="match-date">${date}</div>
                        </div>
                    `;
                } else if (match.match_type === 'doubles') {
                    const team1 = `${match.player1} & ${match.player2}`;
                    const team2 = `${match.player3} & ${match.player4}`;
                    const team1Won = match.winner1 === match.player1 || match.winner1 === match.player2;
                    return `
                        <div class="match-item">
                            <div class="match-type">Doubles</div>
                            <div class="match-players">
                                <span class="${team1Won ? 'match-winner' : ''}">${team1}</span>
                                vs
                                <span class="${!team1Won ? 'match-winner' : ''}">${team2}</span>
                            </div>
                            <div class="match-date">${date}</div>
                        </div>
                    `;
                } else if (match.match_type === 'canadian') {
                    return `
                        <div class="match-item">
                            <div class="match-type">Canadian Doubles (to ${match.target_score})</div>
                            <div class="match-players">
                                ${match.player1}: ${match.score_player1} ¬∑ 
                                ${match.player2}: ${match.score_player2} ¬∑ 
                                ${match.player3}: ${match.score_player3}
                            </div>
                            <div class="match-date">${date}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Render insights
        function renderInsights() {
            const container = document.getElementById('insights');
            const insights = [];

            // Singles insights
            const singlesMatches = matches.filter(m => m.match_type === 'singles');
            
            // Calculate H2H records
            const h2h = {};
            singlesMatches.forEach(match => {
                const key = [match.player1, match.player2].sort().join('_');
                if (!h2h[key]) h2h[key] = { matches: [], players: [match.player1, match.player2].sort() };
                h2h[key].matches.push(match);
            });

            // Find interesting patterns
            Object.values(h2h).forEach(record => {
                if (record.matches.length >= 3) {
                    const [p1, p2] = record.players;
                    const p1Wins = record.matches.filter(m => m.winner1 === p1).length;
                    const p2Wins = record.matches.length - p1Wins;
                    
                    // Check for recent streak change
                    const recentMatches = record.matches.slice(0, 3);
                    const recentWinner = recentMatches[0].winner1;
                    const recentStreak = recentMatches.filter(m => m.winner1 === recentWinner).length;
                    
                    if (recentStreak === 3) {
                        const otherPlayer = recentWinner === p1 ? p2 : p1;
                        const otherWins = recentWinner === p1 ? p2Wins : p1Wins;
                        const winnerTotalWins = recentWinner === p1 ? p1Wins : p2Wins;
                        
                        if (otherWins > winnerTotalWins - 3) {
                            insights.push({
                                type: 'streak',
                                text: `üî• ${recentWinner} has won the last 3 against ${otherPlayer}, turning around a ${otherWins}-${winnerTotalWins - 3} deficit!`
                            });
                        } else {
                            insights.push({
                                type: 'streak',
                                text: `üî• ${recentWinner} is on a 3-match winning streak vs ${otherPlayer}`
                            });
                        }
                    }

                    // Dominant H2H
                    if (record.matches.length >= 5) {
                        const dominant = p1Wins > p2Wins ? p1 : p2;
                        const dominantWins = Math.max(p1Wins, p2Wins);
                        const ratio = dominantWins / record.matches.length;
                        if (ratio >= 0.7) {
                            insights.push({
                                type: 'stat',
                                text: `üìä ${dominant} owns the H2H vs ${dominant === p1 ? p2 : p1}: ${dominantWins}-${record.matches.length - dominantWins}`
                            });
                        }
                    }
                }
            });

            // Canadian doubles insights
            const canadianMatches = matches.filter(m => m.match_type === 'canadian');
            if (canadianMatches.length >= 3) {
                const recentScores = {};
                PLAYERS.forEach(p => recentScores[p] = []);
                
                canadianMatches.slice(0, 5).forEach(match => {
                    if (match.player1) recentScores[match.player1].push(match.score_player1);
                    if (match.player2) recentScores[match.player2].push(match.score_player2);
                    if (match.player3) recentScores[match.player3].push(match.score_player3);
                });

                // Find hot/cold players
                PLAYERS.forEach(player => {
                    const scores = recentScores[player];
                    if (scores.length >= 3) {
                        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                        if (avg >= 8) {
                            insights.push({
                                type: 'stat',
                                text: `üìà ${player} is in hot form! Averaging ${avg.toFixed(1)} pts in recent Canadian doubles`
                            });
                        }
                    }
                });
            }

            // Overall stats
            if (singlesMatches.length > 0) {
                const winCounts = {};
                PLAYERS.forEach(p => winCounts[p] = 0);
                singlesMatches.forEach(m => {
                    if (m.winner1) winCounts[m.winner1]++;
                });
                const topWinner = Object.entries(winCounts).sort((a, b) => b[1] - a[1])[0];
                if (topWinner[1] > 0) {
                    insights.push({
                        type: 'stat',
                        text: `üëë ${topWinner[0]} leads overall singles wins with ${topWinner[1]} victories`
                    });
                }
            }

            if (insights.length === 0) {
                container.innerHTML = '<div class="empty-state">Play more matches to unlock insights!</div>';
                return;
            }

            container.innerHTML = insights.slice(0, 5).map(insight => `
                <div class="insight-item ${insight.type}">${insight.text}</div>
            `).join('');
        }

        // H2H selectors
        function initH2HSelectors() {
            ['h2hPlayer1', 'h2hPlayer2'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateH2H);
            });
        }

        function updateH2H() {
            const p1 = document.getElementById('h2hPlayer1').value;
            const p2 = document.getElementById('h2hPlayer2').value;
            const container = document.getElementById('h2hResult');

            if (!p1 || !p2 || p1 === p2) {
                container.innerHTML = '<div class="empty-state">Select two different players</div>';
                return;
            }

            const singlesMatches = matches.filter(m => 
                m.match_type === 'singles' &&
                ((m.player1 === p1 && m.player2 === p2) || (m.player1 === p2 && m.player2 === p1))
            );

            if (singlesMatches.length === 0) {
                container.innerHTML = `<div class="empty-state">No singles matches between ${p1} and ${p2}</div>`;
                return;
            }

            const p1Wins = singlesMatches.filter(m => m.winner1 === p1).length;
            const p2Wins = singlesMatches.length - p1Wins;

            container.innerHTML = `
                <div class="h2h-result">
                    <div class="h2h-label">${p1}</div>
                    <div class="h2h-score">${p1Wins} - ${p2Wins}</div>
                    <div class="h2h-label">${p2}</div>
                </div>
                <div style="margin-top: 20px;">
                    <div class="form-label">Recent matches</div>
                    ${singlesMatches.slice(0, 5).map(m => {
                        const date = new Date(m.created_at).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
                        return `<div class="match-item">
                            <span class="${m.winner1 === p1 ? 'match-winner' : ''}">${p1}</span> vs 
                            <span class="${m.winner1 === p2 ? 'match-winner' : ''}">${p2}</span>
                            <span class="match-date">${date}</span>
                        </div>`;
                    }).join('')}
                </div>
            `;
        }

        // Toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
